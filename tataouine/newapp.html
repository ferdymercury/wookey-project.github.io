

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>9.11. Creating a new Application &mdash; Wookey 0.9.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/wookey.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9.12. The build system internals" href="internals.html" />
    <link rel="prev" title="9.10. Creating a new library" href="newlib.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Wookey
          

          
            
            <img src="../_static/wookey_w.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../target.html">1. About the WooKey project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">2. Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../demo.html">3. Demo applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">4. Wookey architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ewok/index.html">5. EwoK kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../libs.html">6. Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../drivers.html">7. Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../javacard/index.html">8. Javacard Applets</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tataouine.html">9. Tataouine SDK</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="dependencies.html">9.1. Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="repo.html">9.2. Downloading the project with repo</a></li>
<li class="toctree-l2"><a class="reference internal" href="externals.html">9.3. External dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="config.html">9.4. Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="build.html">9.5. Building a new firmware</a></li>
<li class="toctree-l2"><a class="reference internal" href="flash.html">9.6. Flashing a new firmware</a></li>
<li class="toctree-l2"><a class="reference internal" href="production.html">9.7. Production mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="debug.html">9.8. Debugging the project</a></li>
<li class="toctree-l2"><a class="reference internal" href="newdriver.html">9.9. Creating a new driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="newlib.html">9.10. Creating a new library</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">9.11. Creating a new application</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-is-a-wookey-application">9.11.1. What is a WooKey application?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-application-source-directory-structure">9.11.2. The application source directory structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#writing-your-first-basic-application">9.11.3. Writing your first basic application</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-application-makefile">9.11.3.1. The application Makefile</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-application-kconfig">9.11.3.2. The application Kconfig</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#integrating-your-application-to-the-tataouine-sdk">9.11.4. Integrating your application to the Tataouine SDK</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="internals.html">9.12. Internals</a></li>
<li class="toctree-l2"><a class="reference internal" href="layout.html">9.13. Layout and portability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tataouine.html#tataouine-directories">9.14. Tataouine directories</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../hard.html">10. Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publi.html">11. Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">12. Roadmap</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Wookey</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../tataouine.html">9. Tataouine SDK</a> &raquo;</li>
        
      <li>9.11. Creating a new Application</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="creating-a-new-application">
<h1><a class="toc-backref" href="#id1">9.11. Creating a new Application</a><a class="headerlink" href="#creating-a-new-application" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#creating-a-new-application" id="id1">Creating a new Application</a><ul>
<li><a class="reference internal" href="#what-is-a-wookey-application" id="id2">What is a WooKey application?</a></li>
<li><a class="reference internal" href="#the-application-source-directory-structure" id="id3">The application source directory structure</a></li>
<li><a class="reference internal" href="#writing-your-first-basic-application" id="id4">Writing your first basic application</a><ul>
<li><a class="reference internal" href="#the-application-makefile" id="id5">The application Makefile</a></li>
<li><a class="reference internal" href="#the-application-kconfig" id="id6">The application Kconfig</a></li>
</ul>
</li>
<li><a class="reference internal" href="#integrating-your-application-to-the-tataouine-sdk" id="id7">Integrating your application to the Tataouine SDK</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="what-is-a-wookey-application">
<h2><a class="toc-backref" href="#id2">9.11.1. What is a WooKey application?</a><a class="headerlink" href="#what-is-a-wookey-application" title="Permalink to this headline">¶</a></h2>
<p>An application is a standalone software embedding all the needed content (apart from the application loader)
and built on top of the EwoK microkernel. Applications interact with EwoK through <strong>syscalls</strong>.</p>
<p>Usually, libraries (such as the standard library) wrap such syscalls exposing higher level helpers. Applications can
also interact with the hardware if they are allowed to (see the permissions model), and must initialize
devices using dedicated syscalls. Higher level helpers for hardware interactions are also provided to
the application in the form of userland drivers libraries (such as the USART library).</p>
<p>An application can use any of the SoCs, boards, cores and drivers sources to be able to run on the target.</p>
</div>
<div class="section" id="the-application-source-directory-structure">
<h2><a class="toc-backref" href="#id3">9.11.2. The application source directory structure</a><a class="headerlink" href="#the-application-source-directory-structure" title="Permalink to this headline">¶</a></h2>
<p>A typical application named <em>myapp</em> is hosted in apps/myapp.</p>
<p>The application directory structure is composed of four main elements:</p>
<blockquote>
<div><ul class="simple">
<li>Its Makefile</li>
<li>Its configuration file (named Kconfig)</li>
<li>Its main.c source file (usually hosted in src/ relative directory)</li>
<li>a README.md file, describing the purpose of the application</li>
</ul>
</div></blockquote>
<p>And that should be all!</p>
<p>The myapp directory should look like this:</p>
<blockquote>
<div>./src/main.c
./Kconfig
./Makefile
./README.md</div></blockquote>
</div>
<div class="section" id="writing-your-first-basic-application">
<h2><a class="toc-backref" href="#id4">9.11.3. Writing your first basic application</a><a class="headerlink" href="#writing-your-first-basic-application" title="Permalink to this headline">¶</a></h2>
<div class="section" id="the-application-makefile">
<h3><a class="toc-backref" href="#id5">9.11.3.1. The application Makefile</a><a class="headerlink" href="#the-application-makefile" title="Permalink to this headline">¶</a></h3>
<p>The application Makefile allows to specify which library is needed by
the application. The Makefile is also the link between the SDK and the
application.</p>
<p>All applications Makefiles are nearly identical. Only the application’s
dependencies (libs, drivers) and paths varies.</p>
<p>Here is a sample Makefile for a given application:</p>
<div class="highlight-make notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c">###################################################################</span>
<span class="c"># About the application name and path</span>
<span class="c">###################################################################</span>

<span class="c"># Application name, can be suffixed by the SDK</span>
<span class="nv">APP_NAME</span> <span class="o">?=</span> crypto
<span class="c"># application build directory name</span>
<span class="nv">DIR_NAME</span> <span class="o">:=</span> crypto

<span class="c"># project root directory, relative to app dir</span>
<span class="nv">PROJ_FILES</span> <span class="o">=</span> ../../

<span class="c"># binary, hex and elf file names</span>
<span class="nv">BIN_NAME</span> <span class="o">=</span> <span class="k">$(</span>APP_NAME<span class="k">)</span>.bin
<span class="nv">HEX_NAME</span> <span class="o">=</span> <span class="k">$(</span>APP_NAME<span class="k">)</span>.hex
<span class="nv">ELF_NAME</span> <span class="o">=</span> <span class="k">$(</span>APP_NAME<span class="k">)</span>.elf

<span class="c"># SDK helper Makefiles inclusion</span>
<span class="cp">-include $(PROJ_FILES)/m_config.mk</span>
<span class="cp">-include $(PROJ_FILES)/m_generic.mk</span>

<span class="c"># application build directory, relative to the SDK BUILD_DIR environment</span>
<span class="c"># variable.</span>
<span class="nv">APP_BUILD_DIR</span> <span class="o">=</span> <span class="k">$(</span>BUILD_DIR<span class="k">)</span>/apps/<span class="k">$(</span>DIR_NAME<span class="k">)</span>

<span class="c">###################################################################</span>
<span class="c"># About the compilation flags</span>
<span class="c">###################################################################</span>

<span class="c"># Application CFLAGS, first yours... Remember no use &#39;+=&#39; as the SDK</span>
<span class="c"># create an initial CLFAGS value for application</span>
<span class="nv">CFLAGS</span> <span class="o">+=</span> -Isrc/ -Iinc/ -MMD -MP
<span class="c"># and the SDK ones</span>
<span class="nv">CFLAGS</span> <span class="o">+=</span> <span class="k">$(</span>APPS_CFLAGS<span class="k">)</span>

<span class="c">###################################################################</span>
<span class="c"># About the link step</span>
<span class="c">###################################################################</span>

<span class="c"># the layout file, must be named &#39;myapp.fw1.ld&#39; for default. is overriden by</span>
<span class="c"># the SDK in multi-bank case.</span>
<span class="c"># this is an option of the linker.</span>
<span class="nv">EXTRA_LDFLAGS</span> <span class="o">?=</span> -Tpin.fw1.ld

<span class="c"># linker options to add the layout file</span>
<span class="nv">LDFLAGS</span> <span class="o">+=</span> <span class="k">$(</span>EXTRA_LDFLAGS<span class="k">)</span> -L<span class="k">$(</span>APP_BUILD_DIR<span class="k">)</span>

<span class="c"># generic linker options</span>
<span class="nv">LDFLAGS</span> <span class="o">+=</span> <span class="k">$(</span>AFLAGS<span class="k">)</span> -fno-builtin -nostdlib -nostartfiles

<span class="c"># project&#39;s library/drivers you whish to use..., dont forget to add your application</span>
<span class="c"># build directory as library source path (-L argument)</span>
<span class="nv">LD_LIBS</span> <span class="o">+=</span> -lcryp -laes -lstd -L<span class="k">$(</span>APP_BUILD_DIR<span class="k">)</span>

<span class="c">###################################################################</span>
<span class="c"># okay let&#39;s list our source files and generated files now</span>
<span class="c">###################################################################</span>

<span class="nv">CSRC_DIR</span> <span class="o">=</span> src
<span class="nv">SRC</span> <span class="o">=</span> <span class="k">$(</span>wildcard <span class="k">$(</span>CSRC_DIR<span class="k">)</span>/*.c<span class="k">)</span>
<span class="nv">OBJ</span> <span class="o">=</span> <span class="k">$(</span>patsubst %.c,<span class="k">$(</span>APP_BUILD_DIR<span class="k">)</span>/%.o,<span class="k">$(</span>SRC<span class="k">))</span>
<span class="nv">DEP</span> <span class="o">=</span> <span class="k">$(</span>OBJ:.o<span class="o">=</span>.d<span class="k">)</span>

<span class="c"># the output directories, that will be deleted by the distclean target</span>
<span class="nv">OUT_DIRS</span> <span class="o">=</span> <span class="k">$(</span>dir <span class="k">$(</span>OBJ<span class="k">))</span>

<span class="c"># the ldcript file generated by the SDK</span>
<span class="nv">LDSCRIPT_NAME</span> <span class="o">=</span> <span class="k">$(</span>APP_BUILD_DIR<span class="k">)</span>/<span class="k">$(</span>APP_NAME<span class="k">)</span>.ld

<span class="c"># file to (dist)clean</span>

<span class="c"># first, objects and compilation related</span>
<span class="nv">TODEL_CLEAN</span> <span class="o">+=</span> <span class="k">$(</span>OBJ<span class="k">)</span> <span class="k">$(</span>DEP<span class="k">)</span> <span class="k">$(</span>LDSCRIPT_NAME<span class="k">)</span>

<span class="c"># the overall target content</span>
<span class="nv">TODEL_DISTCLEAN</span> <span class="o">+=</span> <span class="k">$(</span>APP_BUILD_DIR<span class="k">)</span>

<span class="nf">.PHONY</span><span class="o">:</span> <span class="n">app</span>

<span class="c">#############################################################</span>
<span class="c"># Informations about the applications</span>
<span class="c">#############################################################</span>

<span class="nf">show</span><span class="o">:</span>
	@echo
	@echo <span class="s2">&quot;\t\tAPP_BUILD_DIR\t=&gt; &quot;</span> <span class="k">$(</span>APP_BUILD_DIR<span class="k">)</span>
	@echo
	@echo <span class="s2">&quot;C sources files:&quot;</span>
	@echo <span class="s2">&quot;\t\tSRC\t=&gt; &quot;</span> <span class="k">$(</span>SRC<span class="k">)</span>
	@echo <span class="s2">&quot;\t\tASM\t=&gt; &quot;</span> <span class="k">$(</span>ASM<span class="k">)</span>
	@echo <span class="s2">&quot;\t\tOBJ\t=&gt; &quot;</span> <span class="k">$(</span>OBJ<span class="k">)</span>
	@echo <span class="s2">&quot;\t\tDEP\t=&gt; &quot;</span> <span class="k">$(</span>DEP<span class="k">)</span>
	@echo
	@echo <span class="s2">&quot;\t\tCFLAGS\t=&gt; &quot;</span> <span class="k">$(</span>CFLAGS<span class="k">)</span>
	@echo <span class="s2">&quot;\t\tLDLAGS\t=&gt; &quot;</span> <span class="k">$(</span>LDLAGS<span class="k">)</span>



<span class="c">###################################################################</span>
<span class="c"># build targets (driver, core, SoC, Board... and local)</span>
<span class="c">###################################################################</span>

<span class="c"># all (default) build the app</span>
<span class="nf">all</span><span class="o">:</span> <span class="k">$(</span><span class="nv">APP_BUILD_DIR</span><span class="k">)</span> <span class="n">alldeps</span> <span class="n">app</span>

<span class="c">############################################################</span>
<span class="c"># eplicit dependency on the application libs and drivers</span>
<span class="c"># compiling the application requires the compilation of its</span>
<span class="c"># dependencies</span>
<span class="c"># This permit to compile all the application dependencies</span>
<span class="c"># when requesting the application compilation</span>
<span class="c">############################################################</span>

<span class="c"># library dependencies, here we have 2 libs</span>
<span class="nv">LIBDEP</span> <span class="o">:=</span> <span class="k">$(</span>BUILD_DIR<span class="k">)</span>/libs/libstd/libstd.a <span class="se">\</span>
          <span class="k">$(</span>BUILD_DIR<span class="k">)</span>/libs/libaes/libaes.a

<span class="nf">libdep</span><span class="o">:</span> <span class="k">$(</span><span class="nv">LIBDEP</span><span class="k">)</span>

<span class="nf">$(LIBDEP)</span><span class="o">:</span>
	<span class="k">$(</span>Q<span class="k">)$(</span>MAKE<span class="k">)</span> -C <span class="k">$(</span>PROJ_FILES<span class="k">)</span>libs/<span class="k">$(</span>patsubst lib%.a,%,<span class="k">$(</span>notdir <span class="nv">$@</span><span class="k">))</span>


<span class="c"># drivers dependencies, here only one</span>
<span class="nv">SOCDRVDEP</span> <span class="o">:=</span> <span class="k">$(</span>BUILD_DIR<span class="k">)</span>/drivers/libcryp/libcryp.a

<span class="nf">socdrvdep</span><span class="o">:</span> <span class="k">$(</span><span class="nv">SOCDRVDEP</span><span class="k">)</span>

<span class="nf">$(SOCDRVDEP)</span><span class="o">:</span>
	<span class="k">$(</span>Q<span class="k">)$(</span>MAKE<span class="k">)</span> -C <span class="k">$(</span>PROJ_FILES<span class="k">)</span>drivers/socs/<span class="k">$(</span>SOC<span class="k">)</span>/<span class="k">$(</span>patsubst lib%.a,%,<span class="k">$(</span>notdir <span class="nv">$@</span><span class="k">))</span>

<span class="c"># board drivers dependencies. If none, leave the variable empty</span>
<span class="nv">BRDDRVDEP</span>    <span class="o">:=</span>

<span class="nf">brddrvdep</span><span class="o">:</span> <span class="k">$(</span><span class="nv">BRDDRVDEP</span><span class="k">)</span>

<span class="nf">$(BRDDRVDEP)</span><span class="o">:</span>
	<span class="k">$(</span>Q<span class="k">)$(</span>MAKE<span class="k">)</span> -C <span class="k">$(</span>PROJ_FILES<span class="k">)</span>drivers/boards/<span class="k">$(</span>BOARD<span class="k">)</span>/<span class="k">$(</span>patsubst lib%.a,%,<span class="k">$(</span>notdir <span class="nv">$@</span><span class="k">))</span>

<span class="c"># external dependencies</span>
<span class="nv">EXTDEP</span>    <span class="o">:=</span>

<span class="nf">extdep</span><span class="o">:</span> <span class="k">$(</span><span class="nv">EXTDEP</span><span class="k">)</span>

<span class="nf">$(EXTDEP)</span><span class="o">:</span>
	<span class="k">$(</span>Q<span class="k">)$(</span>MAKE<span class="k">)</span> -C <span class="k">$(</span>PROJ_FILES<span class="k">)</span>externals


<span class="c"># alldeps, including all dependencies (see &#39;all&#39; target, which depends on it)</span>
<span class="nf">alldeps</span><span class="o">:</span> <span class="n">libdep</span> <span class="n">socdrvdep</span> <span class="n">brddrvdep</span> <span class="n">extdep</span>


<span class="c">###################################################################</span>
<span class="c"># build targets (driver, core, SoC, Board... and local)</span>
<span class="c">###################################################################</span>

<span class="c"># app build the hex and elf binaries</span>
<span class="nf">app</span><span class="o">:</span> <span class="k">$(</span><span class="nv">APP_BUILD_DIR</span><span class="k">)</span>/<span class="k">$(</span><span class="nv">ELF_NAME</span><span class="k">)</span> <span class="k">$(</span><span class="nv">APP_BUILD_DIR</span><span class="k">)</span>/<span class="k">$(</span><span class="nv">HEX_NAME</span><span class="k">)</span>

<span class="c"># objet files and dependencies</span>
<span class="nf">$(APP_BUILD_DIR)/%.o</span><span class="o">:</span> %.<span class="n">c</span>
	<span class="k">$(</span>call if_changed,cc_o_c<span class="k">)</span>

<span class="c"># ELF file dependencies. libs are build separately and before.</span>
<span class="c"># Be sure to add the libs to your config file!</span>
<span class="nf">$(APP_BUILD_DIR)/$(ELF_NAME)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">OBJ</span><span class="k">)</span>
	<span class="k">$(</span>call if_changed,link_o_target<span class="k">)</span>

<span class="c"># same for hex</span>
<span class="nf">$(APP_BUILD_DIR)/$(HEX_NAME)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">APP_BUILD_DIR</span><span class="k">)</span>/<span class="k">$(</span><span class="nv">ELF_NAME</span><span class="k">)</span>
	<span class="k">$(</span>call if_changed,objcopy_ihex<span class="k">)</span>

<span class="c"># same for bin. bin is not build but you can add it if you whish</span>
<span class="nf">$(APP_BUILD_DIR)/$(BIN_NAME)</span><span class="o">:</span> <span class="k">$(</span><span class="nv">APP_BUILD_DIR</span><span class="k">)</span>/<span class="k">$(</span><span class="nv">ELF_NAME</span><span class="k">)</span>
	<span class="k">$(</span>call if_changed,objcopy_bin<span class="k">)</span>

<span class="c"># special target to create the application build directory</span>
<span class="nf">$(APP_BUILD_DIR)</span><span class="o">:</span>
	<span class="k">$(</span>call cmd,mkdir<span class="k">)</span>

<span class="c"># including automaticaly calculated headers/sources dependencies</span>
<span class="cp">-include $(DEP)</span>
</pre></div>
</td></tr></table></div>
<p>Inclusion path of libraries and drivers is implicitly added
by Tataouine through the APPS_CFLAGS variable.</p>
<p>As a consequence, including a library or a driver in the C code can be done by using the following syntax:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;api/headername.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<p>The application layout is automatically generated.</p>
<p>It is important to respect the following variable names, as they are used by
the SDK and overloaded as input variables for advanced mechanisms such as multi-bank support:</p>
<blockquote>
<div><ul class="simple">
<li>APP_NAME</li>
<li>EXTRA_LDFLAGS</li>
</ul>
</div></blockquote>
<p>Some variables are set by the SDK (through the included m_config.mk file):</p>
<blockquote>
<div><ul class="simple">
<li>BUILD_DIR       : the build directory of the project</li>
<li>AFLAGS          : the architecture-specific compilation flags</li>
<li>APPS_CFLAGS     : libs and drivers inclusion flags and other
arch-specific and warning flags</li>
<li>PROJ_FILES      : the project root directory path</li>
</ul>
</div></blockquote>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">Please do not set these variables using <strong>:=</strong>, use instead <strong>?=</strong> for paths and <strong>+=</strong> for flags to support overloading, as shown in the sample Makefile</p>
</div>
</div>
<div class="section" id="the-application-kconfig">
<h3><a class="toc-backref" href="#id6">9.11.3.2. The application Kconfig</a><a class="headerlink" href="#the-application-kconfig" title="Permalink to this headline">¶</a></h3>
<p>Like all applications, yours must be configured. A typical example is the
permissions configuration, but also the required memory or stack. All these information can
be set using a Kconfig file (same syntax as the Linux kernel) which allows
the usage of ncurses or GTK-based configuration.</p>
<p>Like for Makefiles, applications Kconfig are nearly the same. Only the
application name varies.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">You can use the application Kconfig file to add other
application-specific configuration elements if needed</p>
</div>
<p>80% of the Kconfig file is dedicated to the permissions.</p>
<p>Here is a sample Kconfig file.</p>
<div class="highlight-kconfig notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># starting PIN application configuration</span>
<span class="k">menu</span> <span class="s2">&quot;PIN custom app&quot;</span>

<span class="k">config</span> APP_PIN
  <span class="nb">bool</span> <span class="s2">&quot;Pin App&quot;</span>
  <span class="k">depends on</span> STM32F4
  <span class="k">default</span> y
  <span class="k">---help---</span>
    Say y <span class="k">if</span> you want to embbed USER custom application.

<span class="c1"># start of (de)actication PIN option list</span>
<span class="c1"># all the config entry here depends on the activation of the application</span>
<span class="k">if</span> APP_PIN

<span class="k">config</span> APP_PIN_FW
  <span class="nb">bool</span> <span class="s2">&quot;Pin App for firmware mode&quot;</span>
  <span class="k">depends on</span> STM32F4
  <span class="k">default</span> y
  <span class="k">---help---</span>
    Say y <span class="k">if</span> you want to embbed Pin custom application in firmware.

<span class="k">config</span> APP_PIN_DFU
  <span class="nb">bool</span> <span class="s2">&quot;Pin App for DFU mode&quot;</span>
  <span class="k">depends on</span> FIRMWARE_DFU
  <span class="k">depends on</span> STM32F4
  <span class="k">default</span> y
  <span class="k">---help---</span>
    Say y <span class="k">if</span> you want to embbed Pin custom application in DFU.


<span class="k">config</span> APP_PIN_NUMSLOTS
  <span class="nb">int</span> <span class="s2">&quot;Number of required slots&quot;</span>
  <span class="k">default</span> <span class="mi">1</span>
  <span class="k">---help---</span>
    specify the number of slots required by the application text and data/bss.
    remember that the number of total slots is limited by the hardware.
    For example, there is <span class="mi">8</span> <span class="mi">32</span>kb sized slots in STM32F4, reduced to <span class="mi">7</span> when using SHM for
    .text + .data in flash, and <span class="mi">8</span> <span class="p">(</span>reduced to <span class="mi">7</span> with SHM) slots of <span class="mi">16</span>kb in RAM.
    This <span class="k">choice</span> has an impact on the total number of applications that can be loaded
    in the firmware.

<span class="k">config</span> APP_PIN_STACKSIZE
  <span class="nb">int</span> <span class="s2">&quot;Stack size&quot;</span>
  <span class="k">default</span> <span class="mi">8192</span>
  <span class="k">---help---</span>
    Specify the application stack size, in bytes. By <span class="k">default</span>, set to <span class="mi">8192</span>
    <span class="p">(</span>i.e. <span class="mi">8</span>k). Depending on the number of slots required, and the usage,
    the stack can be bigger or smaller.


<span class="c1"># start of PIN permission configuration</span>
<span class="k">menu</span> <span class="s2">&quot;Permissions&quot;</span>

<span class="k">menu</span> <span class="s2">&quot;Devices&quot;</span>

<span class="k">config</span> APP_PIN_PERM_DEV_DMA
    <span class="nb">bool</span> <span class="s2">&quot;App has capacity to register DMA streams&quot;</span>
    <span class="k">default</span> n
    <span class="k">---help---</span>
    <span class="k">if</span> no, the application can&#39;t declare a DMA. If y, the application
    is able to require one or more secure DMA stream(s).

<span class="k">config</span> APP_PIN_PERM_DEV_CRYPTO
    <span class="nb">int</span> <span class="s2">&quot;App can interact with HW cryptographic module&quot;</span>
    <span class="k">default</span> <span class="mi">0</span>
    <span class="k">range</span> <span class="mi">0</span> <span class="mi">3</span>
    <span class="k">---help---</span>
    If <span class="mi">0</span>, the application has no access to any HW cryp module.
    If <span class="mi">1</span>, the application is able to use a HW cryp module configured
    by another application.
    If <span class="mi">2</span>, the application is able to configure <span class="p">(</span>inject keys) but can&#39;t
    use the crypt module <span class="p">(</span>no IRQ handler).
    If <span class="mi">3</span>, the application as a full, autonomous access to the HW cryp
    module

<span class="k">config</span> APP_PIN_PERM_DEV_BUSES
    <span class="nb">bool</span> <span class="s2">&quot;App has capacity to use buses (SPI, I2C, USART...)&quot;</span>
    <span class="k">default</span> n
    <span class="k">---help---</span>
    If n, the application can&#39;t access any buses <span class="p">(</span>I2C, SPI, USART).
    If y, the application can require a bus mapping.

<span class="k">config</span> APP_PIN_PERM_DEV_EXTI
    <span class="nb">bool</span> <span class="s2">&quot;App can use EXTI or GPIO driven external interrupts&quot;</span>
    <span class="k">default</span> n

<span class="k">config</span> APP_PIN_PERM_DEV_TIM
    <span class="nb">bool</span> <span class="s2">&quot;App can register a hardware timer&quot;</span>
    <span class="k">default</span> n
    <span class="k">---help---</span>
    If n, the application can&#39;t require a timer from the kernel <span class="p">(</span>using
    the timer API). If y, the application can require one or more HW
    timer(s).

<span class="k">endmenu</span>

<span class="k">menu</span> <span class="s2">&quot;Time&quot;</span>

<span class="k">config</span> APP_PIN_PERM_TIM_GETCYCLES
    <span class="nb">int</span> <span class="s2">&quot;App has capacity to get current timestamp from kernel&quot;</span>
    <span class="k">default</span> <span class="mi">0</span>
    <span class="k">range</span> <span class="mi">0</span> <span class="mi">3</span>
    <span class="k">---help---</span>
    If <span class="mi">0</span>, the application has no access to timestamping.
    If <span class="mi">1</span>, the application is able to get tick accurate timestamping.
    If <span class="mi">2</span>, the application is able to get microsecond accurate timestamping.
    If <span class="mi">3</span>, the application is able to get cycle accurate timestamping.

<span class="k">endmenu</span>

<span class="k">menu</span> <span class="s2">&quot;Tasking&quot;</span>

<span class="k">config</span> APP_PIN_PERM_TSK_FISR
    <span class="nb">bool</span> <span class="s2">&quot;App is allowed to request main thread execution after ISR&quot;</span>
    <span class="k">default</span> n
    <span class="k">---help---</span>
    If y, the application is able to request its main thread execution
    just after specific ISRs. This is done using the dev_irq_mode_t
    structure in device_t struct, using the IRQ_ISR_FORCE_MAINTHREAD value.
    If n, this field can&#39;t be set to this value.

<span class="k">config</span> APP_PIN_PERM_TSK_FIPC
    <span class="nb">bool</span> <span class="s2">&quot;App is allowed to request peer execution on syncrhnous send IPC&quot;</span>
    <span class="k">default</span> n
    <span class="k">---help---</span>
    If y, the application is able to request peer thread execution
    when sending syncrhonous IPC.

<span class="k">config</span> APP_PIN_PERM_TSK_RESET
    <span class="nb">bool</span> <span class="s2">&quot;App is allowed to request a board software reset&quot;</span>
    <span class="k">default</span> n
    <span class="k">---help---</span>
    If y, the application is able to request a MCU reset. This is usefull
    only <span class="k">if</span> the application is handling events that require urgent reactivity
    implying board reset.

<span class="k">config</span> APP_PIN_PERM_TSK_UPGRADE
    <span class="nb">bool</span> <span class="s2">&quot;App is allowed to upgrade the firmware&quot;</span>
    <span class="k">default</span> n
    <span class="k">---help---</span>
    If y, the application is able to map the embedded flash device in
    order to upgrade the overall firmware. This permission should
    be hosted by a task with no external access <span class="p">(</span>USB, USART...)



<span class="k">endmenu</span>

<span class="k">menu</span> <span class="s2">&quot;Memory management&quot;</span>

<span class="k">config</span> APP_PIN_PERM_MEM_DYNAMIC_MAP
    <span class="nb">bool</span> <span class="s2">&quot;App is allow to declare MAP_VOLUNTARY devices&quot;</span>
    <span class="k">default</span> n
    <span class="k">---help---</span>
    If y, the task is allowed to declare devices that are not automatically
    mapped, but that are mapped/unmapped voluntary using sys_cfg() syscalls.
    This permission does not give access to any devices not already declared
    but allow dynamic <span class="p">(</span>un)mapping of previously declared ones.

<span class="k">endmenu</span>


<span class="k">endmenu</span>
<span class="c1"># end of PIN permission configuration</span>

<span class="c1"># Here we can add one (or more) menu, submenu and so on, which</span>
<span class="c1"># are specific to the application behavior.</span>
<span class="c1"># The menu structure is free, but the option prefix should respect</span>
<span class="c1"># the global application prefix (here APP_PIN) to avoid any collision</span>
<span class="c1"># or confusion with other part of the configuration</span>
<span class="c1">#</span>
<span class="c1"># start of PIN specific option configuration</span>
<span class="k">menu</span> <span class="s2">&quot;Application specific options&quot;</span>

<span class="k">choice</span>
  <span class="k">prompt</span> <span class="s2">&quot;PIN human interaction mode&quot;</span>
  <span class="k">default</span> APP_PIN_INPUT_USART
    <span class="k">config</span> APP_PIN_INPUT_USART
      <span class="nb">bool</span> <span class="s2">&quot;PIN is asked through USART&quot;</span>
      <span class="k">---help---</span>
      User interaction for PIN ask is done using dedicated
      USART interface
    <span class="k">config</span> APP_PIN_INPUT_SCREEN
      <span class="nb">bool</span> <span class="s2">&quot;PIN is asked through graphical interface&quot;</span>
      <span class="k">---help---</span>
      User interaction for PIN ask is done using dedicated
      screen/touchscreen couple
<span class="k">endchoice</span>

<span class="k">if</span> APP_PIN_INPUT_USART
  <span class="k">config</span> APP_PIN_INPUT_USART_ID
  <span class="nb">int</span> <span class="s2">&quot;PIN USART interface identifier&quot;</span>
  <span class="k">range</span> <span class="mi">1</span> <span class="mi">6</span>
<span class="k">endif</span>

<span class="k">endmenu</span>
<span class="c1"># end of PIN specific option configuration</span>

<span class="c1"># end of (de)actication PIN option list</span>
<span class="k">endif</span>

<span class="k">endmenu</span>
<span class="c1"># end of PIN application configuration</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="integrating-your-application-to-the-tataouine-sdk">
<h2><a class="toc-backref" href="#id7">9.11.4. Integrating your application to the Tataouine SDK</a><a class="headerlink" href="#integrating-your-application-to-the-tataouine-sdk" title="Permalink to this headline">¶</a></h2>
<p>This is done by updating the manifest file to add your application repository.
The SDK automatically detects that your application is added to the apps/ subdirectory
and integrates it to the configuration subsystem.</p>
<p>Now, you only have to activate it using menuconfig, in the same way you
configure the Linux kernel, by executing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">menuconfig</span>
</pre></div>
</div>
<p>Go to <em>Userspace drivers and features</em>, <em>Applications</em>. You should see your application
and should be able to activate it. Until your configuration is saved, you can now
directly compile and flash the new version of the firmware with your application
integrated in it.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<dl class="last docutils">
<dt>Please beware of the following limitations when adding new applications:</dt>
<dd><ul class="first last simple">
<li>The number of available slots for applications is limited. Too much
applications will induce a compilation error</li>
<li>The user is responsible of the memory ressource management of new applications (stack usage and so on).
Some configuration errors here (for instance a stack too small for the app memory needs) will
not be caught at compile time, and will lead to crashes (due to memory errors caught by the MPU)
that can be hard to debug</li>
<li>Mistakes and inconsistencies when setting the applications permissions could lead to runtime
hazardous errors!</li>
<li>The user must check the consistency of device drivers usage when adding new
applications. For instance, if two applications both try to use USART4 concurrently,
one of it will have its request refused by the kernel. As a general rule of thumb, sharing the
same piece of hardware in two or more applications (i.e. registers handling the same peripheral) is
not permitted and must be resolved by using a userspace proxy</li>
</ul>
</dd>
</dl>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="internals.html" class="btn btn-neutral float-right" title="9.12. The build system internals" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="newlib.html" class="btn btn-neutral" title="9.10. Creating a new library" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, ANSSI

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.9.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>